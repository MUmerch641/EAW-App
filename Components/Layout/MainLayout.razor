@inherits LayoutComponentBase
@inject AuthenticationStateService AuthState
@inject INavigationService NavigationService
@inject IJSRuntime JSRuntime

<div class="modern-layout">
    @if (AuthState.IsAuthenticated)
    {
        <!-- Mobile Backdrop -->
        <div class="layout-backdrop @(sidebarOpen ? "open" : "")" @onclick="ToggleSidebar"></div>

        <!-- Sidebar Navigation -->
        <aside class="modern-sidebar @(sidebarOpen ? "open" : "")">
            <div class="sidebar-header">
                <div class="brand-logo">
                    <!-- Placeholder or Icon -->
                    <div class="logo-circle">EW</div>
                    <span class="brand-name">Everything<br/>at Work</span>
                </div>
            </div>
            
            <div class="sidebar-content">
                <NavMenu />
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="modern-main">
            <!-- Top Header -->
            <header class="modern-header glass-panel">
                <button class="menu-toggle" @onclick="ToggleSidebar">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                
                <div class="header-title">
                     <!-- Title removed to avoid conflict with PageHeader -->
                    <span class="page-title">Everything at Work</span> 
                </div>

                <div class="header-actions">
                    <button class="icon-btn" @onclick="GoToNotifications" title="Notifications">
                        <span class="fas fa-bell"></span>
                    </button>
                    <!-- Profile Icon -->
                    <div class="user-avatar-small" @onclick="GoToProfile" style="cursor: pointer;">
                        @GetInitials()
                    </div>
                </div>
            </header>

            <!-- Scrollable Content -->
            <div class="content-body">
                <div class="page-transition-wrapper">
                    @Body
                </div>
            </div>
        </main>
    }
    else
    {
        <!-- Login / Public Layout -->
        <main class="public-layout">
            @Body
        </main>
    }
</div>

@inject NavigationManager NavManager

@code {
    private bool sidebarOpen = false;
    private IDisposable? navigationHandler;

    protected override async Task OnInitializedAsync()
    {
        // Restore session if needed
        await AuthState.InitializeAsync();
        
        // Subscribe to location changes to close sidebar on mobile navigation
        navigationHandler = NavManager.RegisterLocationChangingHandler((context) =>
        {
            try
            {
                if (sidebarOpen)
                {
                    sidebarOpen = false;
                    _ = InvokeAsync(StateHasChanged);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[LAYOUT] Error in LocationChangingHandler: {ex.Message}");
            }
            return ValueTask.CompletedTask;
        });
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Task.Delay(500);
            await JSRuntime.InvokeVoidAsync("blazorHelpers.hideLoadingScreen");
        }
    }

    private void ToggleSidebar()
    {
        sidebarOpen = !sidebarOpen;
        StateHasChanged();
    }

    private void GoToNotifications()
    {
        NavManager.NavigateTo("/task-notifications");
    }

    private void GoToProfile()
    {
        NavManager.NavigateTo("/profile");
    }
    
    private string GetInitials()
    {
        if (AuthState.CurrentUser == null) return "?";
        var name = AuthState.CurrentUser.FullName ?? AuthState.CurrentUser.Username;
        if (string.IsNullOrEmpty(name)) return "?";
        return name.Substring(0, 1).ToUpper();
    }

    public void Dispose()
    {
        navigationHandler?.Dispose();
    }
}
