@inject IMainPageDataService MainPageService
@inject AuthenticationStateService AuthState
@inject INavigationService NavigationService
@inject NavigationManager NavManager
@inject IJSRuntime JSRuntime
@using MauiHybridApp.Models.DataObjects

<div class="modern-nav-menu">
    <!-- Optional: Profile Summary in Menu (if desired) -->
    <div class="nav-profile-section">
        @if (AuthState.CurrentUser != null)
        {
            <div class="nav-profile-info">
                <span class="nav-profile-name">@AuthState.CurrentUser.FullName</span>
                <span class="nav-profile-role">@AuthState.CurrentUser.Position</span>
            </div>
        }
    </div>

    <nav class="nav-links">
        @if (menuItems != null)
        {
            @foreach (var item in menuItems)
            {
                <div class="nav-item-wrapper">
                    <NavLink class="modern-nav-link" href="@item.Route" Match="NavLinkMatch.All">
                        <span class="nav-icon @item.Icon" aria-hidden="true"></span>
                        <span class="nav-text">@item.Title</span>
                    </NavLink>
                </div>
            }
        }

        <div class="nav-divider"></div>

        <div class="nav-item-wrapper">
            <button class="modern-nav-link logout-btn" @onclick="Logout">
                <span class="nav-icon oi oi-account-logout" aria-hidden="true"></span>
                <span class="nav-text">Logout</span>
            </button>
        </div>
    </nav>
</div>

@code {
    private List<MenuItem>? menuItems;

    protected override async Task OnInitializedAsync()
    {
        await LoadMenuItems();
    }

    private async Task LoadMenuItems()
    {
        try
        {
            // For demo mode, return static menu items to avoid API calls
            menuItems = new List<MenuItem>
            {
                new MenuItem { Title = "Dashboard", Route = "/dashboard", Icon = "oi oi-dashboard" },
                new MenuItem { Title = "Leave", Route = "/leave", Icon = "oi oi-calendar" },
                new MenuItem { Title = "Overtime", Route = "/overtime", Icon = "oi oi-clock" },
                new MenuItem { Title = "Official Business", Route = "/official-business", Icon = "oi oi-briefcase" },
                new MenuItem { Title = "Time Off", Route = "/time-off-request", Icon = "oi oi-timer" },
                new MenuItem { Title = "Time Entry", Route = "/time-entry", Icon = "oi oi-clock" },
                new MenuItem { Title = "Expenses", Route = "/expenses", Icon = "oi oi-dollar" },
                new MenuItem { Title = "Approvals", Route = "/approvals", Icon = "oi oi-check" },
                new MenuItem { Title = "Payslips", Route = "/payslips", Icon = "oi oi-document" },
                new MenuItem { Title = "Attendance", Route = "/attendance", Icon = "oi oi-target" },
                new MenuItem { Title = "Performance Evaluation", Route = "/performance-evaluation", Icon = "oi oi-graph" },
                new MenuItem { Title = "Individual Objectives", Route = "/individual-objectives", Icon = "oi oi-bullseye" },
                new MenuItem { Title = "Employees", Route = "/employee-list", Icon = "oi oi-people" },
                new MenuItem { Title = "Profile", Route = "/profile", Icon = "oi oi-person" },
                new MenuItem { Title = "Settings", Route = "/settings", Icon = "oi oi-cog" }
            };

            // PRODUCTION CODE (commented out for demo):
            /*
            // Load menu items from service
            var response = await MainPageService.GetMenuItemsAsync();
            if (response != null && response.Any())
            {
                menuItems = response.Cast<MenuItemModel>().Select(m => new MenuItem
                {
                    Title = m.MenuName,
                    Route = GetRouteFromMenuName(m.MenuName),
                    Icon = GetIconFromMenuName(m.MenuName)
                }).ToList();
            }
            */
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error loading menu: {ex.Message}");
            // Fallback to static menu
            menuItems = new List<MenuItem>
            {
                new MenuItem { Title = "Dashboard", Route = "/dashboard", Icon = "oi oi-dashboard" },
                new MenuItem { Title = "Profile", Route = "/profile", Icon = "oi oi-person" }
            };
        }
    }

    private string GetRouteFromMenuName(string menuName)
    {
        return menuName.ToLower() switch
        {
            "dashboard" => "/dashboard",
            "leave" => "/leave",
            "overtime" => "/overtime",
            "official business" => "/official-business",
            "time off" => "/time-off-request",
            "time entry" => "/time-entry",
            "approvals" => "/approvals",
            "payslips" => "/payslips",
            "attendance" => "/attendance",
            "payroll" => "/payroll",
            "performance" => "/performance",
            "employee relations" => "/employee-relations",
            "profile" => "/profile",
            "expenses" => "/expenses",
            _ => "/"
        };
    }

    private string GetIconFromMenuName(string menuName)
    {
        return menuName.ToLower() switch
        {
            "dashboard" => "oi oi-dashboard",
            "leave" => "oi oi-calendar",
            "overtime" => "oi oi-clock",
            "official business" => "oi oi-briefcase",
            "time off" => "oi oi-timer",
            "time entry" => "oi oi-timer",
            "approvals" => "oi oi-check",
            "payslips" => "oi oi-document",
            "attendance" => "oi oi-people",
            "expenses" => "oi oi-dollar",
            "payroll" => "oi oi-dollar",
            "performance" => "oi oi-graph",
            "employee relations" => "oi oi-comment-square",
            "profile" => "oi oi-person",
            _ => "oi oi-menu"
        };
    }

    private string GetInitials()
    {
        if (AuthState.CurrentUser == null) return "?";
        
        // Use FullName if available, otherwise use Username
        var fullName = !string.IsNullOrEmpty(AuthState.CurrentUser.FullName) 
            ? AuthState.CurrentUser.FullName 
            : AuthState.CurrentUser.Username;
        
        if (string.IsNullOrEmpty(fullName)) return "?";
        
        var names = fullName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (names.Length == 0) return "?";
        
        if (names.Length > 1)
        {
            return $"{names[0][0]}{names[^1][0]}".ToUpper();
        }
        else
        {
            return names[0].Length > 1 
                ? $"{names[0][0]}{names[0][1]}".ToUpper() 
                : $"{names[0][0]}".ToUpper();
        }
    }

    private async Task Logout()
    {
        await AuthState.LogoutAsync();
        await NavigationService.NavigateToAsync("/");
    }

    private void OnNavigate(string route)
    {
        try
        {
            Console.WriteLine($"[NAV] Navigating to: {route}");
            NavManager.NavigateTo(route);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[NAV] Navigation error: {ex.Message}");
        }
    }

    private class MenuItem
    {
        public string Title { get; set; } = string.Empty;
        public string Route { get; set; } = string.Empty;
        public string Icon { get; set; } = string.Empty;
    }
}

