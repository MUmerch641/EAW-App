@using MauiHybridApp.Models
@using MauiHybridApp.Services.Data
@inject IWorkflowDataService WorkflowService

<div class="transaction-history-modal @(IsVisible ? "show" : "")">
    <div class="modal-backdrop" @onclick="Close"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>Transaction History</h3>
            <button class="btn-close" @onclick="Close">&times;</button>
        </div>
        
        <div class="modal-body">
            @if (IsLoading)
            {
                <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            }
            else if (HistoryItems == null || !HistoryItems.Any())
            {
                <div class="empty-state">
                    <p>No history available.</p>
                </div>
            }
            else
            {
                <div class="history-list">
                    @foreach (var item in HistoryItems)
                    {
                        <div class="history-item">
                            <div class="history-icon @GetHistoryIconColor(item.HistoryTypeId)">
                                <i class="@GetHistoryIconClass(item.HistoryTypeId)"></i>
                            </div>
                            <div class="history-details">
                                <div class="history-header">
                                    <span class="user-name">@item.CreatedBy</span>
                                    <span class="history-date">@item.LogDate.ToString("MMM dd, yyyy h:mm tt")</span>
                                </div>
                                <div class="history-action">
                                    @((MarkupString)(string.IsNullOrEmpty(item.MessageTemplate) ? item.DetailedMessage : item.MessageTemplate))
                                </div>
                                @if (!string.IsNullOrEmpty(item.Remarks))
                                {
                                    <div class="history-remarks">
                                        <strong>Remarks:</strong> @item.Remarks
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>



@code {
    [Parameter]
    public bool IsVisible { get; set; }
    
    [Parameter]
    public EventCallback<bool> IsVisibleChanged { get; set; }

    [Parameter]
    public long TransactionTypeId { get; set; }

    [Parameter]
    public long TransactionId { get; set; }

    private List<TransactionHistory>? HistoryItems;
    private bool IsLoading = false;

    // Triggered when params are set or manually by parent
    public async Task LoadHistoryAsync(long typeId, long id)
    {
        TransactionTypeId = typeId;
        TransactionId = id;
        IsLoading = true;
        StateHasChanged();

        try
        {
            HistoryItems = await WorkflowService.GetTransactionHistoryAsync(TransactionTypeId, TransactionId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading history: {ex.Message}");
            HistoryItems = new List<TransactionHistory>();
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task Close()
    {
        IsVisible = false;
        await IsVisibleChanged.InvokeAsync(false);
    }
    
    // Helper to determine icon based on HistoryTypeId (mapped from Xamarin/Backend usually)
    private string GetHistoryIconClass(long historyTypeId)
    {
        return historyTypeId switch
        {
            1 => "fas fa-paper-plane", // Submitted
            2 => "fas fa-check",       // Approved
            3 => "fas fa-times",       // Rejected
            4 => "fas fa-ban",         // Cancelled
            _ => "fas fa-info"
        };
    }
    
    private string GetHistoryIconColor(long historyTypeId)
    {
        return historyTypeId switch
        {
            1 => "bg-info",        // Submitted
            2 => "bg-success",     // Approved
            3 => "bg-danger",      // Rejected
            4 => "bg-secondary",   // Cancelled
            _ => "bg-primary"
        };
    }
}
