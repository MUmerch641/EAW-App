@page "/time-entry"
@inject AuthenticationStateService AuthState
@inject ITimeEntryDataService TimeEntryService
@inject NavigationManager NavManager
@inject IJSRuntime JSRuntime

<div class="page-container">
    <div class="page-header">
        <button class="btn-back" @onclick="GoBack">
            <span class="oi oi-arrow-left"></span>
        </button>
        <h1>Time Entry</h1>
    </div>

    <div class="page-content">
        @if (isLoading)
        {
            <div class="loading-container">
                <div class="spinner"></div>
                <p>Loading time entry...</p>
            </div>
        }
        else
        {
            <!-- Current Status Card -->
            <div class="status-card">
                <div class="status-header">
                    <h2>Current Status</h2>
                    <div class="current-time">@currentTime.ToString("HH:mm:ss")</div>
                </div>
                
                <div class="status-info">
                    @if (currentTimeEntry != null)
                    {
                        <div class="status-item">
                            <span class="label">Status:</span>
                            <span class="value status-@(isCurrentlyClockedIn ? "in" : "out")">
                                @(isCurrentlyClockedIn ? "Clocked In" : "Clocked Out")
                            </span>
                        </div>
                        
                        @if (isCurrentlyClockedIn && currentTimeEntry != null)
                        {
                            <div class="status-item">
                                <span class="label">Time In:</span>
                                <span class="value">@currentTimeEntry.TimeEntry.ToString("HH:mm")</span>
                            </div>
                            <div class="status-item">
                                <span class="label">Duration:</span>
                                <span class="value">@GetWorkDuration()</span>
                            </div>
                        }
                        
                        @if (!isCurrentlyClockedIn && currentTimeEntry != null)
                        {
                            <div class="status-item">
                                <span class="label">Last Time Out:</span>
                                <span class="value">@currentTimeEntry.TimeEntry.ToString("HH:mm")</span>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="status-item">
                            <span class="label">Status:</span>
                            <span class="value status-out">Not Clocked In</span>
                        </div>
                    }
                </div>
            </div>

            <!-- Clock In/Out Actions -->
            <div class="action-card">
                <div class="location-info">
                    <div class="location-item">
                        <span class="oi oi-location-pin"></span>
                        <span>@(currentLocation ?? "Getting location...")</span>
                    </div>
                </div>

                <div class="action-buttons">
                    @if (!isCurrentlyClockedIn)
                    {
                        <button class="btn btn-clock-in" @onclick="ClockIn" disabled="@isSubmitting">
                            @if (isSubmitting)
                            {
                                <span class="spinner-border spinner-border-sm" role="status"></span>
                                <span> Clocking In...</span>
                            }
                            else
                            {
                                <span class="oi oi-clock"></span>
                                <span>Clock In</span>
                            }
                        </button>
                    }
                    else
                    {
                        <button class="btn btn-clock-out" @onclick="ClockOut" disabled="@isSubmitting">
                            @if (isSubmitting)
                            {
                                <span class="spinner-border spinner-border-sm" role="status"></span>
                                <span> Clocking Out...</span>
                            }
                            else
                            {
                                <span class="oi oi-clock"></span>
                                <span>Clock Out</span>
                            }
                        </button>
                    }
                </div>
            </div>

            <!-- Today's Time Entries -->
            <div class="entries-card">
                <h3>Today's Time Entries</h3>
                
                @if (todayEntries != null && todayEntries.Any())
                {
                    <div class="entries-list">
                        @foreach (var entry in todayEntries.OrderByDescending(e => e.TimeEntry))
                        {
                            <div class="entry-item">
                                <div class="entry-type">
                                    <span class="type-badge @(entry.Type == "Time-In" ? "type-in" : "type-out")">
                                        @entry.Type
                                    </span>
                                </div>
                                <div class="entry-time">
                                    <span class="time">@entry.TimeEntry.ToString("HH:mm")</span>
                                    <span class="date">@entry.TimeEntry.ToString("MMM dd")</span>
                                </div>
                                <div class="entry-location">
                                    <span class="location">@(string.IsNullOrEmpty(entry.Location) ? "Unknown" : entry.Location)</span>
                                </div>
                            </div>
                        }
                    </div>
                    
                    <div class="total-hours">
                        <span class="label">Total Hours Today:</span>
                        <span class="value">@GetTotalHoursToday()</span>
                    </div>
                }
                else
                {
                    <div class="no-entries">
                        <span class="oi oi-info"></span>
                        <p>No time entries for today</p>
                    </div>
                }
            </div>

            <!-- Error Messages -->
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger">
                    @errorMessage
                    <button class="btn btn-sm btn-outline-light ms-2" @onclick="LoadTimeEntries">
                        <span class="oi oi-reload"></span> Retry
                    </button>
                </div>
            }

            <!-- Success Messages -->
            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="alert alert-success">
                    @successMessage
                </div>
            }
        }
    </div>
</div>

<style>
    .page-container { background-color: #f0f2f5; min-height: 100vh; display: flex; flex-direction: column; }
    .page-header { background: #667eea; padding: 15px; display: flex; align-items: center; color: white; }
    .btn-back { background: none; border: none; color: white; font-size: 20px; margin-right: 15px; }
    .page-header h1 { font-size: 20px; margin: 0; font-weight: 600; }
    
    .page-content { padding: 20px; flex: 1; }
    
    .status-card, .action-card, .entries-card {
        background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .status-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .status-header h2 { font-size: 16px; color: #666; margin: 0; }
    .current-time { font-size: 24px; font-weight: bold; color: #333; }
    
    .status-item { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 15px; }
    .value.status-in { color: #28a745; font-weight: bold; }
    .value.status-out { color: #dc3545; font-weight: bold; }
    
    .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; color: white; font-size: 18px; }
    .btn-clock-in { background: #28a745; }
    .btn-clock-out { background: #dc3545; }
    
    .type-badge { padding: 5px 10px; border-radius: 15px; font-size: 12px; }
    .type-badge.type-in { background: #d4edda; color: #155724; }
    .type-badge.type-out { background: #f8d7da; color: #721c24; }
    
    .entry-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
    .entry-time { font-weight: bold; color: #333; }
</style>
