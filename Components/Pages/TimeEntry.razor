@page "/time-entry"
@using System.ComponentModel
@using MauiHybridApp.ViewModels
@inject TimeEntryViewModel ViewModel
@implements IDisposable

<div class="page-container">
    <PageHeader 
        Title="Time Entry" 
        Subtitle="Clock in and out" 
        IconClass="fa-clock" />
    
    @if (ViewModel.IsBusy)
    {
        <LoadingIndicator Message="Loading..." />
    }
    else
    {
        <div class="content-section">
            @if (!string.IsNullOrEmpty(ViewModel.ErrorMessage))
            {
                <AlertMessage Type="error" Message="@ViewModel.ErrorMessage" />
            }
            
            @if (!string.IsNullOrEmpty(ViewModel.SuccessMessage))
            {
                <AlertMessage Type="success" Message="@ViewModel.SuccessMessage" />
            }
            
            <!-- Current Status Card -->
            <StatusCard 
                Title="Current Status" 
                Value="@ViewModel.StatusText" 
                IconClass="fa-user-clock"
                AdditionalClass="@ViewModel.StatusClass">
                <div class="status-details">
                    <div class="time-display">
                        <div class="current-time">@ViewModel.CurrentTimeFormatted</div>
                        <div class="current-date">@ViewModel.CurrentDateFormatted</div>
                    </div>
                    
                    @if (ViewModel.IsCurrentlyClockedIn && ViewModel.CurrentTimeEntry != null)
                    {
                        <div class="info-row">
                            <span class="label">Time In:</span>
                            <span class="value">@ViewModel.CurrentTimeEntry.TimeEntry.ToString("hh:mm tt")</span>
                        </div>
                    }
                    
                    <div class="info-row">
                        <span class="label">Location:</span>
                        <span class="value">@ViewModel.CurrentLocation</span>
                    </div>
                </div>
            </StatusCard>
            
            <!-- Action Buttons -->
            <div class="action-section">
                <ActionButton 
                    Text="Clock In" 
                    OnClick="@(() => ViewModel.ClockInCommand.Execute(null))" 
                    IsDisabled="@(ViewModel.IsCurrentlyClockedIn || ViewModel.IsBusy)"
                    IsPrimary="true"
                    IconClass="fa-sign-in-alt" />
                    
                <ActionButton 
                    Text="Clock Out" 
                    OnClick="@(() => ViewModel.ClockOutCommand.Execute(null))" 
                    IsDisabled="@(!ViewModel.IsCurrentlyClockedIn || ViewModel.IsBusy)"
                    IsPrimary="false"
                    IconClass="fa-sign-out-alt" />
            </div>
            
            <!-- Time Entry History -->
            <div class="history-section">
                <h3 class="section-title">
                    <i class="fa fa-history"></i>
                    Recent Entries
                </h3>
                
                @if (ViewModel.TimeEntries.Any())
                {
                    <div class="entry-list">
                        @foreach (var entry in ViewModel.TimeEntries.Take(10))
                        {
                            <div class="entry-item">
                                <div class="entry-icon @(entry.Type == "Time-In" ? "icon-in" : "icon-out")">
                                    <i class="fa @(entry.Type == "Time-In" ? "fa-sign-in-alt" : "fa-sign-out-alt")"></i>
                                </div>
                                <div class="entry-details">
                                    <div class="entry-type">@entry.Type</div>
                                    <div class="entry-time">@entry.TimeEntry.ToString("MMM dd, yyyy - hh:mm tt")</div>
                                </div>
                                <div class="entry-status @entry.Status.ToLower()">
                                    @entry.Status
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <EmptyState 
                        Message="No time entries found" 
                        IconClass="fa-clock" />
                }
            </div>
        </div>
    }
</div>

@code {
    private PropertyChangedEventHandler? _propertyChangedHandler;

    protected override async Task OnInitializedAsync()
    {
        _propertyChangedHandler = (sender, e) => _ = InvokeAsync(StateHasChanged);
        ViewModel.PropertyChanged += _propertyChangedHandler;
        
        await ViewModel.InitializeAsync();
    }
    
    public void Dispose()
    {
        if (_propertyChangedHandler != null && ViewModel != null)
        {
            ViewModel.PropertyChanged -= _propertyChangedHandler;
            _propertyChangedHandler = null;
        }
        
        ViewModel?.Dispose();
    }
}
}
