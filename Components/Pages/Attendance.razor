@page "/attendance"
@using System.ComponentModel
@using MauiHybridApp.ViewModels
@using MauiHybridApp.Models.Attendance
@inject AttendanceViewModel ViewModel
@implements IDisposable

<div class="page-container">
    <PageHeader 
        Title="Attendance" 
        Subtitle="View your attendance records" 
        IconClass="fa-calendar-check" />
    
    @if (ViewModel.IsBusy)
    {
        <LoadingIndicator Message="Loading..." />
    }
    else
    {
        <div class="content-section">
            @if (!string.IsNullOrEmpty(ViewModel.ErrorMessage))
            {
                <AlertMessage Type="error" Message="@ViewModel.ErrorMessage" />
            }
            
            <!-- Date Range Filter -->
            <div class="filter-section">
                <h3 class="section-title">
                    <i class="fa fa-filter"></i>
                    Filter by Date Range
                </h3>
                
                <div class="date-filters">
                    <FormGroup Label="Start Date" For="startDate">
                        <input type="date" 
                               id="startDate"
                               class="form-control"
                               @bind="ViewModel.StartDate" />
                    </FormGroup>

                    <FormGroup Label="End Date" For="endDate">
                        <input type="date" 
                               id="endDate"
                               class="form-control"
                               @bind="ViewModel.EndDate" />
                    </FormGroup>
                </div>

                <div class="quick-filters">
                    <ActionButton Text="Today"
                                IconClass="fa-calendar-day"
                                OnClick="@(() => ViewModel.SetQuickFilterCommand.Execute("today"))"
                                IsPrimary="false" />
                    <ActionButton Text="This Week"
                                IconClass="fa-calendar-week"
                                OnClick="@(() => ViewModel.SetQuickFilterCommand.Execute("week"))"
                                IsPrimary="false" />
                    <ActionButton Text="This Month"
                                IconClass="fa-calendar-alt"
                                OnClick="@(() => ViewModel.SetQuickFilterCommand.Execute("month"))"
                                IsPrimary="false" />
                </div>
            </div>

            <!-- Attendance Summary -->
            @if (ViewModel.AttendanceSummary != null)
            {
                <div class="summary-section">
                    <h3 class="section-title">
                        <i class="fa fa-chart-bar"></i>
                        Attendance Summary
                    </h3>
                    
                    <div class="summary-grid">
                        <StatusCard Title="Total Days"
                                  Value="@ViewModel.AttendanceSummary.TotalDays.ToString()"
                                  IconClass="fa-calendar" />
                        <StatusCard Title="Present Days"
                                  Value="@ViewModel.AttendanceSummary.PresentDays.ToString()"
                                  IconClass="fa-check-circle" />
                        <StatusCard Title="Absent Days"
                                  Value="@ViewModel.AttendanceSummary.AbsentDays.ToString()"
                                  IconClass="fa-times-circle" />
                        <StatusCard Title="Late Days"
                                  Value="@ViewModel.AttendanceSummary.LateDays.ToString()"
                                  IconClass="fa-clock" />
                        <StatusCard Title="Total Hours"
                                  Value="@ViewModel.AttendanceSummary.TotalHours.ToString("F1")"
                                  IconClass="fa-hourglass-half" />
                        <StatusCard Title="Avg Hours/Day"
                                  Value="@ViewModel.AttendanceSummary.AverageHoursPerDay.ToString("F1")"
                                  IconClass="fa-chart-line" />
                    </div>
                </div>
            }

            <!-- Attendance Records -->
            <div class="history-section">
                <h3 class="section-title">
                    <i class="fa fa-list"></i>
                    Attendance Records (@ViewModel.AttendanceRecords.Count)
                </h3>
                
                @if (ViewModel.HasRecords)
                {
                    <div class="entry-list">
                        @foreach (var record in ViewModel.AttendanceRecords)
                        {
                            <div class="record-card">
                                <div class="record-date">
                                    <span class="day">@record.Date.ToString("dd")</span>
                                    <span class="month">@record.Date.ToString("MMM")</span>
                                </div>
                                <div class="record-details">
                                    <div class="record-status @record.Status?.ToLower()">
                                        <i class="fa @GetStatusIcon(record.Status)"></i>
                                        @record.Status
                                    </div>
                                    <div class="record-times">
                                        @if (record.TimeIn.HasValue)
                                        {
                                            <span>In: @record.TimeIn.Value.ToString("hh:mm tt")</span>
                                        }
                                        @if (record.TimeOut.HasValue)
                                        {
                                            <span>Out: @record.TimeOut.Value.ToString("hh:mm tt")</span>
                                        }
                                    </div>
                                    @if (record.TotalHours.HasValue)
                                    {
                                        <div class="record-hours">
                                            @record.TotalHours.Value.ToString("F1") hours
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <EmptyState 
                        Message="No attendance records found for the selected date range" 
                        IconClass="fa-calendar-times" />
                }
            </div>
        </div>
    }
</div>

@code {
    private PropertyChangedEventHandler? _propertyChangedHandler;

    protected override async Task OnInitializedAsync()
    {
        _propertyChangedHandler = (sender, e) => _ = InvokeAsync(StateHasChanged);
        ViewModel.PropertyChanged += _propertyChangedHandler;
        
        await ViewModel.InitializeAsync();
    }
    
    public void Dispose()
    {
        if (_propertyChangedHandler != null && ViewModel != null)
        {
            ViewModel.PropertyChanged -= _propertyChangedHandler;
            _propertyChangedHandler = null;
        }
        
        ViewModel?.Dispose();
    }

    private string GetStatusIcon(string? status)
    {
        return status?.ToLower() switch
        {
            "present" => "fa-check-circle",
            "absent" => "fa-times-circle",
            "late" => "fa-clock",
            "half-day" => "fa-adjust",
            _ => "fa-question-circle"
        };
    }
}
