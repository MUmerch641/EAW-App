@page "/dashboard"
@using MauiHybridApp.ViewModels
@inject DashboardViewModel ViewModel
@implements IDisposable

<div class="dashboard-container">
    <!-- Header Section -->
    <div class="dashboard-header">
        <h1>@ViewModel.UserGreeting</h1>
        <p class="text-muted">@ViewModel.CurrentDate</p>
    </div>

    <!-- Loading State -->
    @if (ViewModel.IsBusy)
    {
        <LoadingIndicator Message="@ViewModel.BusyText" />
    }
    
    <!-- Error State -->
    @if (ViewModel.HasError)
    {
        <AlertMessage Type="danger" Message="@ViewModel.ErrorMessage" />
    }

    <!-- Dashboard Content -->
    @if (!ViewModel.IsBusy && !ViewModel.HasError)
    {
        <!-- Statistics Grid -->
        <div class="dashboard-grid">
            <StatusCard 
                Value="@ViewModel.TotalLeaveBalance"
                Label="Total Leave Balance"
                SubLabel="Vacation + Sick Leave"
                Icon="calendar"
                IconColor="bg-primary"
                OnClick="@(() => ViewModel.NavigateToLeaveCommand.Execute(null))" />

            <StatusCard 
                Value="@ViewModel.AbsencesThisMonth"
                Label="Absences"
                SubLabel="This Month"
                Icon="warning"
                IconColor="bg-danger" />

            <StatusCard 
                Value="@ViewModel.TardinessThisMonth"
                Label="Late Arrivals"
                SubLabel="This Month"
                Icon="timer"
                IconColor="bg-warning" />

            <StatusCard 
                Value="@ViewModel.OvertimeThisMonth"
                Label="Overtime Hours"
                SubLabel="This Month"
                Icon="clock"
                IconColor="bg-success"
                OnClick="@(() => ViewModel.NavigateToOvertimeCommand.Execute(null))" />
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions-section">
            <h2>Quick Actions</h2>
            <div class="quick-actions-grid">
                <ActionButton 
                    Text="Time Entry"
                    Icon="clock"
                    Variant="primary"
                    OnClick="@(() => ViewModel.NavigateToTimeEntryCommand.Execute(null))" />

                <ActionButton 
                    Text="Request Leave"
                    Icon="calendar"
                    Variant="success"
                    OnClick="@(() => ViewModel.NavigateToLeaveCommand.Execute(null))" />

                <ActionButton 
                    Text="Overtime Request"
                    Icon="plus"
                    Variant="warning"
                    OnClick="@(() => ViewModel.NavigateToOvertimeCommand.Execute(null))" />

                <ActionButton 
                    Text="View Attendance"
                    Icon="list-rich"
                    Variant="info"
                    OnClick="@(() => ViewModel.NavigateToAttendanceCommand.Execute(null))" />
            </div>
        </div>

        <!-- Refresh Button -->
        <div class="refresh-section">
            <ActionButton 
                Text="Refresh Data"
                Icon="reload"
                Variant="secondary"
                OnClick="@(() => ViewModel.RefreshCommand.Execute(null))"
                IsDisabled="@ViewModel.IsBusy" />
        </div>
    }
</div>

@code {
    /// <summary>
    /// Component initialization - loads dashboard data
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        // Subscribe to ViewModel property changes for UI updates
        ViewModel.PropertyChanged += OnViewModelPropertyChanged;
        
        // Initialize the ViewModel (loads data)
        await ViewModel.InitializeAsync();
    }

    /// <summary>
    /// Handle ViewModel property changes and refresh UI
    /// This is the data binding mechanism in Blazor
    /// </summary>
    private void OnViewModelPropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
    {
        // Refresh the UI when ViewModel properties change
        InvokeAsync(StateHasChanged);
    }

    /// <summary>
    /// Cleanup when component is disposed
    /// </summary>
    public void Dispose()
    {
        if (ViewModel != null)
        {
            ViewModel.PropertyChanged -= OnViewModelPropertyChanged;
        }
    }
}
