@page "/approvals"
@using System.ComponentModel
@using MauiHybridApp.ViewModels
@using MauiHybridApp.Models.Workflow
@inject ApprovalsViewModel ViewModel
@implements IDisposable

<div class="page-container">
    <PageHeader 
        Title="My Approvals" 
        Subtitle="Review and approve requests" 
        IconClass="fa-check-circle" />
    
    @if (ViewModel.IsBusy)
    {
        <LoadingIndicator Message="Loading approvals..." />
    }
    else
    {
        <div class="content-section">
            @if (!string.IsNullOrEmpty(ViewModel.ErrorMessage))
            {
                <AlertMessage Type="error" Message="@ViewModel.ErrorMessage" />
            }
            
            @if (!string.IsNullOrEmpty(ViewModel.SuccessMessage))
            {
                <AlertMessage Type="success" Message="@ViewModel.SuccessMessage" />
            }
            
            <!-- Statistics Cards -->
            <div class="stats-section">
                <StatusCard 
                    Title="Pending" 
                    Value="@ViewModel.PendingCount.ToString()" 
                    IconClass="fa-hourglass-half"
                    AdditionalClass="pending-card" />
                <StatusCard 
                    Title="Total" 
                    Value="@ViewModel.TotalCount.ToString()" 
                    IconClass="fa-list"
                    AdditionalClass="total-card" />
            </div>

            <!-- Filter Tabs -->
            <div class="filter-tabs">
                <ActionButton 
                    Text="Pending" 
                    OnClick="@(() => ViewModel.SetFilterCommand.Execute("pending"))" 
                    IsPrimary="@(ViewModel.ActiveFilter == "pending")"
                    IconClass="fa-hourglass-half" />
                <ActionButton 
                    Text="All" 
                    OnClick="@(() => ViewModel.SetFilterCommand.Execute("all"))" 
                    IsPrimary="@(ViewModel.ActiveFilter == "all")"
                    IconClass="fa-list" />
                <ActionButton 
                    Text="Approved" 
                    OnClick="@(() => ViewModel.SetFilterCommand.Execute("approved"))" 
                    IsPrimary="@(ViewModel.ActiveFilter == "approved")"
                    IconClass="fa-check" />
                <ActionButton 
                    Text="Rejected" 
                    OnClick="@(() => ViewModel.SetFilterCommand.Execute("rejected"))" 
                    IsPrimary="@(ViewModel.ActiveFilter == "rejected")"
                    IconClass="fa-times" />
            </div>

            <!-- Approvals List -->
            <div class="history-section">
                <h3 class="section-title">
                    <i class="fa fa-list"></i>
                    @ViewModel.ActiveFilter (@ViewModel.FilteredApprovals.Count)
                </h3>
                
                @if (ViewModel.HasApprovals)
                {
                    <div class="entry-list">
                        @foreach (var approval in ViewModel.FilteredApprovals)
                        {
                            <div class="approval-card">
                                <div class="approval-header">
                                    <div class="approval-info">
                                        <div class="approval-type">@approval.TransactionType</div>
                                        <div class="requester">@approval.EmployeeName</div>
                                    </div>
                                    <div class="approval-status @approval.Status?.ToLower()">
                                        @approval.Status
                                    </div>
                                </div>
                                <div class="approval-details">
                                    <div class="detail-row">
                                        <span class="label">Transaction ID:</span>
                                        <span class="value">@approval.TransactionId</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="label">Date:</span>
                                        <span class="value">@approval.DateFiled.ToString("MMM dd, yyyy")</span>
                                    </div>
                                    @if (!string.IsNullOrEmpty(approval.Details))
                                    {
                                        <div class="detail-row">
                                            <span class="label">Details:</span>
                                            <span class="value">@approval.Details</span>
                                        </div>
                                    }
                                </div>
                                @if (approval.Status?.ToLower() == "pending")
                                {
                                    <div class="approval-actions">
                                        <ActionButton 
                                            Text="Review" 
                                            OnClick="@(() => ViewModel.OpenApprovalDialogCommand.Execute(approval))" 
                                            IsPrimary="true"
                                            IconClass="fa-eye" />
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
                else
                {
                    <EmptyState 
                        Message="No approvals found" 
                        IconClass="fa-inbox" />
                }
            </div>
        </div>
    }

    <!-- Approval Dialog -->
    @if (ViewModel.ShowApprovalDialog && ViewModel.SelectedApproval != null)
    {
        <div class="modal-overlay">
            <div class="modal-dialog">
                <div class="modal-header">
                    <h3>Review Request</h3>
                    <button class="btn-close" @onclick="@(() => ViewModel.CloseApprovalDialogCommand.Execute(null))">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="approval-info">
                        <h4>@ViewModel.SelectedApproval.TransactionType</h4>
                        <p><strong>Requester:</strong> @ViewModel.SelectedApproval.EmployeeName</p>
                        <p><strong>Transaction ID:</strong> @ViewModel.SelectedApproval.TransactionId</p>
                        <p><strong>Date:</strong> @ViewModel.SelectedApproval.DateFiled.ToString("MMMM dd, yyyy")</p>
                        @if (!string.IsNullOrEmpty(ViewModel.SelectedApproval.Details))
                        {
                            <p><strong>Details:</strong> @ViewModel.SelectedApproval.Details</p>
                        }
                    </div>
                    
                    <FormGroup Label="Comments" For="comments">
                        <textarea 
                            id="comments"
                            class="form-control"
                            rows="4"
                            @bind="ViewModel.ApprovalComments"
                            placeholder="Enter your comments (required for rejection)">
                        </textarea>
                    </FormGroup>
                </div>
                <div class="modal-footer">
                    <ActionButton 
                        Text="Approve" 
                        OnClick="@(() => ViewModel.ApproveCommand.Execute(null))" 
                        IsDisabled="@ViewModel.IsApproving"
                        IsPrimary="true"
                        IconClass="fa-check" />
                    <ActionButton 
                        Text="Reject" 
                        OnClick="@(() => ViewModel.RejectCommand.Execute(null))" 
                        IsDisabled="@ViewModel.IsApproving"
                        IsPrimary="false"
                        IconClass="fa-times" />
                    <ActionButton 
                        Text="Cancel" 
                        OnClick="@(() => ViewModel.CloseApprovalDialogCommand.Execute(null))" 
                        IsDisabled="@ViewModel.IsApproving"
                        IsPrimary="false"
                        IconClass="fa-ban" />
                </div>
            </div>
        </div>
    }
</div>

@code {
    private PropertyChangedEventHandler? _propertyChangedHandler;

    protected override async Task OnInitializedAsync()
    {
        // store handler so we can unsubscribe the same delegate instance later
        _propertyChangedHandler = (sender, e) => _ = InvokeAsync(StateHasChanged);
        ViewModel.PropertyChanged += _propertyChangedHandler;

        await ViewModel.InitializeAsync();
    }

    public void Dispose()
    {
        if (_propertyChangedHandler != null)
        {
            ViewModel.PropertyChanged -= _propertyChangedHandler;
            _propertyChangedHandler = null;
        }

        ViewModel.Dispose();
    }
}
