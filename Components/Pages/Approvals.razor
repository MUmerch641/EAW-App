@page "/approvals"
@using System.ComponentModel
@using MauiHybridApp.ViewModels
@using MauiHybridApp.Models.Workflow
@inject ApprovalsViewModel ViewModel
@implements IDisposable

<div class="page-container">
    <PageHeader 
        Title="My Approvals" 
        Subtitle="Review and approve requests" 
        IconClass="fa-check-circle" />
    
    <!-- Animated Content Wrapper -->
    <div class="animate-fade-in-up">
        @if (ViewModel.IsBusy)
        {
             <div class="p-4">
                <SkeletonLoader height="100px" width="100%" class="mb-3" />
                <SkeletonLoader height="300px" width="100%" />
            </div>
        }
        else
        {
            <div class="content-section">
                @if (!string.IsNullOrEmpty(ViewModel.ErrorMessage))
                {
                    <AlertMessage Type="error" Message="@ViewModel.ErrorMessage" />
                }
                
                @if (!string.IsNullOrEmpty(ViewModel.SuccessMessage))
                {
                    <AlertMessage Type="success" Message="@ViewModel.SuccessMessage" />
                }
                
                <!-- Statistics Cards (Grid Layout) -->
                <div class="stats-section grid-cols-2 gap-3 mb-4">
                    <StatusCard 
                        Title="Pending" 
                        Value="@ViewModel.PendingCount.ToString()" 
                        IconClass="fa-hourglass-half"
                        AdditionalClass="pending-card" />
                    <StatusCard 
                        Title="Total" 
                        Value="@ViewModel.TotalCount.ToString()" 
                        IconClass="fa-list"
                        AdditionalClass="total-card" />
                </div>
    
                <!-- Filter Tabs (Segmented Control Style) -->
                <div class="filter-tabs d-flex gap-2 mb-4 p-1 bg-light rounded-pill overflow-auto">
                    <button class="btn btn-sm rounded-pill flex-grow-1 @(ViewModel.ActiveFilter == "pending" ? "btn-primary shadow-sm" : "btn-light text-muted")"
                            @onclick="@(() => ViewModel.SetFilterCommand.Execute("pending"))">
                        Pending
                    </button>
                    <button class="btn btn-sm rounded-pill flex-grow-1 @(ViewModel.ActiveFilter == "all" ? "btn-primary shadow-sm" : "btn-light text-muted")"
                            @onclick="@(() => ViewModel.SetFilterCommand.Execute("all"))">
                        All
                    </button>
                    <button class="btn btn-sm rounded-pill flex-grow-1 @(ViewModel.ActiveFilter == "approved" ? "btn-success shadow-sm text-white" : "btn-light text-muted")"
                            @onclick="@(() => ViewModel.SetFilterCommand.Execute("approved"))">
                        Approved
                    </button>
                    <button class="btn btn-sm rounded-pill flex-grow-1 @(ViewModel.ActiveFilter == "rejected" ? "btn-danger shadow-sm text-white" : "btn-light text-muted")"
                            @onclick="@(() => ViewModel.SetFilterCommand.Execute("rejected"))">
                        Rejected
                    </button>
                </div>
    
                <!-- Approvals List -->
                <div class="history-section">
                    <h3 class="section-title mb-3 px-1">
                        @ViewModel.ActiveFilter <span class="text-muted fw-normal">(@ViewModel.FilteredApprovals.Count)</span>
                    </h3>
                    
                    @if (ViewModel.HasApprovals)
                    {
                        <div class="entry-list d-flex flex-column gap-3">
                            @foreach (var approval in ViewModel.FilteredApprovals)
                            {
                                <div class="card p-3 shadow-sm border-0 border-radius-lg approval-card">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <div class="fw-bold text-primary fs-6">@approval.TransactionType</div>
                                            <div class="text-dark fw-bold">@approval.EmployeeName</div>
                                        </div>
                                        <span class="badge @(approval.Status?.ToLower() == "pending" ? "bg-warning text-dark" : approval.Status?.ToLower() == "approved" ? "bg-success" : "bg-danger")">
                                            @approval.Status
                                        </span>
                                    </div>
                                    
                                    <div class="text-muted small mb-3">
                                        <div class="d-flex justify-content-between">
                                            <span>Transaction ID: #@approval.TransactionId</span>
                                            <span>@approval.DateFiled.ToString("MMM dd, yyyy")</span>
                                        </div>
                                        @if (!string.IsNullOrEmpty(approval.Details))
                                        {
                                            <div class="mt-1 text-truncate">@approval.Details</div>
                                        }
                                    </div>
                                    
                                    @if (approval.Status?.ToLower() == "pending")
                                    {
                                        <button class="btn btn-primary btn-sm w-100 rounded-pill"
                                                @onclick="@(() => ViewModel.OpenApprovalDialogCommand.Execute(approval))">
                                            <i class="fas fa-eye me-1"></i> Review Request
                                        </button>
                                    }
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <EmptyState 
                            Message="No approvals found" 
                            IconClass="fa-inbox" />
                    }
                </div>
            </div>
        }
    </div>

    <!-- Approval Dialog (Modern Modal) -->
    @if (ViewModel.ShowApprovalDialog && ViewModel.SelectedApproval != null)
    {
        <div class="modal-overlay d-flex align-items-center justify-content-center" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1050;">
            <div class="card shadow-lg border-0" style="width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;">
                <div class="card-header bg-white border-bottom-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                    <h4 class="mb-0 fw-bold">Review Request</h4>
                    <button class="btn btn-light btn-sm rounded-circle" @onclick="@(() => ViewModel.CloseApprovalDialogCommand.Execute(null))">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="card-body px-4 pb-0">
                    <div class="text-center mb-4">
                        <div class="avatar-placeholder rounded-circle bg-primary text-white d-flex align-items-center justify-content-center mx-auto mb-2" style="width: 50px; height: 50px; font-size: 1.2rem;">
                             @(ViewModel.SelectedApproval.EmployeeName?.FirstOrDefault() ?? 'U')
                        </div>
                        <h5 class="fw-bold mb-0">@ViewModel.SelectedApproval.EmployeeName</h5>
                        <p class="text-muted small">@ViewModel.SelectedApproval.TransactionType</p>
                    </div>

                    <div class="bg-light rounded p-3 mb-3 small">
                         <div class="d-flex justify-content-between mb-2">
                             <span class="text-muted">Transaction ID</span>
                             <span class="fw-bold">#@ViewModel.SelectedApproval.TransactionId</span>
                         </div>
                         <div class="d-flex justify-content-between mb-2">
                             <span class="text-muted">Date Filed</span>
                             <span class="fw-bold">@ViewModel.SelectedApproval.DateFiled.ToString("MMM dd, yyyy")</span>
                         </div>
                         @if (ViewModel.SelectedApproval.StartDate.HasValue)
                         {
                             <div class="d-flex justify-content-between mb-2">
                                 <span class="text-muted">Start Date</span>
                                 <span class="fw-bold">@ViewModel.SelectedApproval.StartDate.Value.ToString("MMM dd, yyyy")</span>
                             </div>
                         }
                         @if (ViewModel.SelectedApproval.EndDate.HasValue)
                         {
                             <div class="d-flex justify-content-between">
                                 <span class="text-muted">End Date</span>
                                 <span class="fw-bold">@ViewModel.SelectedApproval.EndDate.Value.ToString("MMM dd, yyyy")</span>
                             </div>
                         }
                    </div>
                    
                    @if (!string.IsNullOrEmpty(ViewModel.SelectedApproval.Details))
                    {
                        <div class="mb-3">
                            <label class="small text-muted fw-bold text-uppercase">Details</label>
                            <p class="small bg-white border rounded p-2 mt-1">@ViewModel.SelectedApproval.Details</p>
                        </div>
                    }
                    
                    <div class="mb-3">
                        <label class="small text-muted fw-bold text-uppercase">Comments (Required for Rejection)</label>
                        <textarea class="form-control modern-input mt-1" 
                                  rows="3" 
                                  placeholder="Enter actionable feedback..."
                                  @bind="ViewModel.ApprovalComments"></textarea>
                    </div>
                </div>
                
                <div class="card-footer bg-white border-top-0 px-4 pb-4 pt-0">
                    <div class="d-flex gap-2">
                         <button class="btn btn-outline-danger flex-grow-1 rounded-pill" 
                                 @onclick="@(() => ViewModel.RejectCommand.Execute(null))"
                                 disabled="@ViewModel.IsApproving">
                             Reject
                         </button>
                         <button class="btn btn-primary flex-grow-1 rounded-pill" 
                                 @onclick="@(() => ViewModel.ApproveCommand.Execute(null))"
                                 disabled="@ViewModel.IsApproving">
                             Approve
                         </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private PropertyChangedEventHandler? _propertyChangedHandler;

    protected override async Task OnInitializedAsync()
    {
        // store handler so we can unsubscribe the same delegate instance later
        _propertyChangedHandler = (sender, e) => _ = InvokeAsync(StateHasChanged);
        ViewModel.PropertyChanged += _propertyChangedHandler;

        await ViewModel.InitializeAsync();
    }

    public void Dispose()
    {
        if (_propertyChangedHandler != null)
        {
            ViewModel.PropertyChanged -= _propertyChangedHandler;
            _propertyChangedHandler = null;
        }

        ViewModel.Dispose();
    }
}
