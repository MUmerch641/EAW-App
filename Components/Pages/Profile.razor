@page "/profile"
@using MauiHybridApp.ViewModels
@inject ProfileViewModel ViewModel
@implements IDisposable

<div class="page-container">
    <!-- Page Header -->
    <PageHeader 
        Title="My Profile" 
        ShowBackButton="true" 
        OnBackClick="@(() => ViewModel.GoBackCommand.Execute(null))">
        <HeaderActions>
            <button class="btn-icon" @onclick="@(() => ViewModel.ToggleEditModeCommand.Execute(null))" disabled="@ViewModel.IsBusy">
                <span class="oi @(ViewModel.IsEditMode ? "oi-x" : "oi-pencil")"></span>
            </button>
        </HeaderActions>
    </PageHeader>

    <div class="page-content">
        <!-- Loading State -->
        @if (ViewModel.IsBusy)
        {
            <LoadingIndicator Message="@ViewModel.BusyText" />
        }
        
        <!-- Error Message -->
        @if (ViewModel.HasError)
        {
            <AlertMessage Type="danger" Message="@ViewModel.ErrorMessage" />
        }
        
        <!-- Success Message -->
        @if (ViewModel.HasSuccessMessage)
        {
            <AlertMessage Type="success" Message="@ViewModel.SuccessMessage" />
        }

        <!-- Profile Content -->
        @if (!ViewModel.IsBusy && ViewModel.UserProfile != null)
        {
            <!-- Profile Photo Section -->
            <div class="profile-photo-section">
                <div class="photo-container">
                    @if (!string.IsNullOrEmpty(ViewModel.UserProfile.ProfilePhotoUrl))
                    {
                        <img src="@ViewModel.UserProfile.ProfilePhotoUrl" alt="Profile Photo" class="profile-photo" />
                    }
                    else
                    {
                        <div class="profile-photo-placeholder">
                            <span class="oi oi-person"></span>
                        </div>
                    }
                    @if (ViewModel.IsEditMode)
                    {
                        <button class="btn-change-photo" @onclick="@(() => ViewModel.ChangePhotoCommand.Execute(null))">
                            <span class="oi oi-camera"></span>
                        </button>
                    }
                </div>
                <h2>@ViewModel.UserProfile.FullName</h2>
                <p class="text-muted">@ViewModel.UserProfile.JobTitle</p>
            </div>

            <!-- Personal Information -->
            <div class="profile-section">
                <h3>Personal Information</h3>
                <div class="info-grid">
                    <FormGroup Label="Employee ID">
                        <span class="value">@ViewModel.UserProfile.EmployeeId</span>
                    </FormGroup>

                    <FormGroup Label="Full Name">
                        <span class="value">@ViewModel.UserProfile.FullName</span>
                    </FormGroup>

                    <FormGroup Label="Email">
                        @if (ViewModel.IsEditMode)
                        {
                            <input type="email" class="form-control" @bind="ViewModel.UserProfile.Email" />
                        }
                        else
                        {
                            <span class="value">@ViewModel.UserProfile.Email</span>
                        }
                    </FormGroup>

                    <FormGroup Label="Phone Number">
                        @if (ViewModel.IsEditMode)
                        {
                            <input type="tel" class="form-control" @bind="ViewModel.UserProfile.PhoneNumber" />
                        }
                        else
                        {
                            <span class="value">@ViewModel.UserProfile.PhoneNumber</span>
                        }
                    </FormGroup>

                    <FormGroup Label="Date of Birth">
                        @if (ViewModel.IsEditMode)
                        {
                            <input type="date" class="form-control" @bind="ViewModel.UserProfile.DateOfBirth" />
                        }
                        else
                        {
                            <span class="value">@ViewModel.UserProfile.DateOfBirth?.ToString("MMMM dd, yyyy")</span>
                        }
                    </FormGroup>

                    <FormGroup Label="Address">
                        @if (ViewModel.IsEditMode)
                        {
                            <textarea class="form-control" @bind="ViewModel.UserProfile.Address" rows="2"></textarea>
                        }
                        else
                        {
                            <span class="value">@ViewModel.UserProfile.Address</span>
                        }
                    </FormGroup>
                </div>
            </div>

            <!-- Employment Information -->
            <div class="profile-section">
                <h3>Employment Information</h3>
                <div class="info-grid">
                    <FormGroup Label="Job Title">
                        <span class="value">@ViewModel.UserProfile.JobTitle</span>
                    </FormGroup>

                    <FormGroup Label="Department">
                        <span class="value">@ViewModel.UserProfile.Department</span>
                    </FormGroup>

                    <FormGroup Label="Manager">
                        <span class="value">@ViewModel.UserProfile.ManagerName</span>
                    </FormGroup>

                    <FormGroup Label="Hire Date">
                        <span class="value">@ViewModel.UserProfile.HireDate?.ToString("MMMM dd, yyyy")</span>
                    </FormGroup>

                    <FormGroup Label="Employment Status">
                        <span class="value">@ViewModel.UserProfile.EmploymentStatus</span>
                    </FormGroup>

                    <FormGroup Label="Work Location">
                        <span class="value">@ViewModel.UserProfile.WorkLocation</span>
                    </FormGroup>
                </div>
            </div>

            <!-- Emergency Contact -->
            <div class="profile-section">
                <h3>Emergency Contact</h3>
                <div class="info-grid">
                    <FormGroup Label="Contact Name">
                        @if (ViewModel.IsEditMode)
                        {
                            <input type="text" class="form-control" @bind="ViewModel.UserProfile.EmergencyContactName" />
                        }
                        else
                        {
                            <span class="value">@ViewModel.UserProfile.EmergencyContactName</span>
                        }
                    </FormGroup>

                    <FormGroup Label="Relationship">
                        @if (ViewModel.IsEditMode)
                        {
                            <input type="text" class="form-control" @bind="ViewModel.UserProfile.EmergencyContactRelationship" />
                        }
                        else
                        {
                            <span class="value">@ViewModel.UserProfile.EmergencyContactRelationship</span>
                        }
                    </FormGroup>

                    <FormGroup Label="Phone Number">
                        @if (ViewModel.IsEditMode)
                        {
                            <input type="tel" class="form-control" @bind="ViewModel.UserProfile.EmergencyContactPhone" />
                        }
                        else
                        {
                            <span class="value">@ViewModel.UserProfile.EmergencyContactPhone</span>
                        }
                    </FormGroup>
                </div>
            </div>

            <!-- Action Buttons -->
            @if (ViewModel.IsEditMode)
            {
                <div class="action-buttons">
                    <ActionButton 
                        Text="Cancel"
                        Variant="secondary"
                        OnClick="@(() => ViewModel.CancelCommand.Execute(null))"
                        IsDisabled="@ViewModel.IsSaving" />
                    
                    <ActionButton 
                        Text="Save Changes"
                        Variant="primary"
                        Icon="check"
                        OnClick="@(() => ViewModel.SaveCommand.Execute(null))"
                        IsLoading="@ViewModel.IsSaving"
                        LoadingText="Saving..." />
                </div>
            }
        }
    </div>
</div>

@code {
    protected override async Task OnInitializedAsync()
    {
        ViewModel.PropertyChanged += OnViewModelPropertyChanged;
        await ViewModel.InitializeAsync();
    }

    private void OnViewModelPropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        if (ViewModel != null)
        {
            ViewModel.PropertyChanged -= OnViewModelPropertyChanged;
        }
    }
}
