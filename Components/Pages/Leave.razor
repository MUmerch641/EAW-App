@page "/leave"
@using System.ComponentModel
@using MauiHybridApp.ViewModels
@inject LeaveViewModel ViewModel
@implements IDisposable

<div class="page-container scrollable">
    <PageHeader 
        Title="Leave Request" 
        Subtitle="Submit a new leave request" 
        IconClass="fa-calendar-alt" />

    <!-- Balance Card -->
    <div class="px-4 mt-2">
        <div class="card p-3 mb-3 shadow-sm border-0 bg-primary text-white d-flex flex-row align-items-center justify-content-between">
             <div>
                <h6 class="mb-1 opacity-75">Available Balance</h6>
                <h2 class="mb-0 fw-bold">@ViewModel.LeaveBalance</h2>
            </div>
            <i class="fas fa-calendar-check fa-2x opacity-50"></i>
        </div>
    </div>
    
    <!-- Animated Content Wrapper -->
    <div class="animate-fade-in-up">
        @if (ViewModel.IsBusy)
        {
             <div class="p-4">
                <SkeletonLoader height="50px" width="100%" class="mb-3" />
                <SkeletonLoader height="300px" width="100%" />
            </div>
        }
        else
        {
            <div class="form-container scrollable-content">
                @if (!string.IsNullOrEmpty(ViewModel.ErrorMessage))
                {
                    <AlertMessage Type="error" Message="@ViewModel.ErrorMessage" />
                }
                
                @if (!string.IsNullOrEmpty(ViewModel.SuccessMessage))
                {
                    <AlertMessage Type="success" Message="@ViewModel.SuccessMessage" />
                }
                
                <div class="form-section">
                    <!-- Main Card -->
                    <div class="card p-4 shadow-sm border-0 border-radius-lg">
                        <h3 class="section-title mb-4 text-primary fw-bold">
                            <i class="fas fa-edit me-2"></i>New Request
                        </h3>
                        
                        <FormGroup Label="Leave Type" IsRequired="true">
                            <select class="modern-input" 
                                    value="@ViewModel.SelectedLeaveTypeId"
                                    @onchange="@((e) => ViewModel.SelectedLeaveTypeId = long.Parse(e.Value?.ToString() ?? "0"))">
                                <option value="0">-- Select Leave Type --</option>
                                @foreach (var type in ViewModel.LeaveTypes)
                                {
                                    <option value="@type.Id">@type.Value</option>
                                }
                            </select>
                        </FormGroup>
                        
                        <!-- Grid Layout for Dates -->
                        <div class="grid-cols-2 gap-3 mb-3">
                            <FormGroup Label="Start Date" IsRequired="true">
                                <input type="date" 
                                       class="modern-input" 
                                       value="@ViewModel.LeaveRequest.InclusiveStartDate?.ToString("yyyy-MM-dd")"
                                       @onchange="@((e) => ViewModel.LeaveRequest.InclusiveStartDate = DateTime.Parse(e.Value?.ToString() ?? DateTime.Today.ToString()))" />
                            </FormGroup>
                            
                            <FormGroup Label="End Date" IsRequired="true">
                                <input type="date" 
                                       class="modern-input" 
                                       value="@ViewModel.LeaveRequest.InclusiveEndDate?.ToString("yyyy-MM-dd")"
                                       @onchange="@((e) => ViewModel.LeaveRequest.InclusiveEndDate = DateTime.Parse(e.Value?.ToString() ?? DateTime.Today.ToString()))" />
                            </FormGroup>
                        </div>
                        
                        <FormGroup Label="Apply To">
                            <select class="modern-input" 
                                    value="@ViewModel.LeaveRequest.PartialDayLeave"
                                    @onchange="@((e) => ViewModel.LeaveRequest.PartialDayLeave = short.Parse(e.Value?.ToString() ?? "0"))">
                                @foreach (var option in ViewModel.ApplyToOptions)
                                {
                                    <option value="@option.Id">@option.Value</option>
                                }
                            </select>
                        </FormGroup>
                        
                        <FormGroup Label="Reason" IsRequired="true">
                            <textarea class="modern-input" 
                                      rows="3" 
                                      placeholder="Enter reason for leave request..."
                                      @bind="ViewModel.LeaveRequest.Reason"></textarea>
                        </FormGroup>
                        
                        <FormGroup Label="Planned Leave">
                            <div class="checkbox-container d-flex align-items-center gap-2 p-2 rounded bg-light">
                                <input type="checkbox" 
                                       id="plannedLeave"
                                       class="form-check-input mt-0"
                                       style="width: 20px; height: 20px;"
                                       checked="@(ViewModel.LeaveRequest.Planned == 1)"
                                       @onchange="@((e) => ViewModel.LeaveRequest.Planned = (bool)(e.Value ?? false) ? (short)1 : (short)0)" />
                                <label for="plannedLeave" class="mb-0 cursor-pointer">This is a planned leave</label>
                            </div>
                        </FormGroup>
                        
                        <div class="mt-3">
                             <FileUpload 
                                Label="Attach Documents (Optional)"
                                HelpText="Attach supporting documents (PDF, DOC, DOCX, JPG, PNG - Max 10MB per file)"
                                AcceptedFileTypes=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                                AllowMultiple="true"
                                MaxFileSize="10485760"
                                OnFilesSelected="@HandleFilesSelected" />
                        </div>

                        <!-- Action Buttons Grid -->
                        <div class="grid-cols-2 gap-3 mt-4">
                             <ActionButton 
                                Text="Cancel" 
                                OnClick="@(() => ViewModel.GoBackCommand.Execute(null))" 
                                IsDisabled="@ViewModel.IsBusy"
                                IsPrimary="false"
                                IconClass="fa-times" />

                             <ActionButton 
                                Text="Submit" 
                                OnClick="@(() => ViewModel.SubmitCommand.Execute(null))" 
                                IsDisabled="@ViewModel.IsBusy"
                                IsPrimary="true"
                                IconClass="fa-paper-plane" />
                        </div>
                    </div>
                </div>

                <!-- Recent History Section -->
                <div class="mt-4 pb-4">
                     <h4 class="section-title mb-3 px-2">Recent Requests</h4>
                     
                     @if (ViewModel.RecentLeaves != null && ViewModel.RecentLeaves.Any())
                     {
                         <div class="history-list">
                             @foreach (var item in ViewModel.RecentLeaves.Take(3))
                             {
                                 <div class="card p-3 mb-2 shadow-sm border-0 d-flex justify-content-between align-items-center">
                                     <div>
                                         <div class="fw-bold text-dark">
                                             @if(item.LeaveTypeId == 1) { <span class="badge bg-primary me-2">Vacation</span> }
                                             else if(item.LeaveTypeId == 2) { <span class="badge bg-warning text-dark me-2">Sick</span> }
                                             else { <span class="badge bg-secondary me-2">Other</span> }
                                             @(item.InclusiveStartDate?.ToString("MMM dd") ?? "") - @(item.InclusiveEndDate?.ToString("MMM dd") ?? "")
                                         </div>
                                         <div class="text-muted small mt-1">@item.Reason</div>
                                     </div>
                                     <div class="text-end">
                                          <span class="badge @(item.StatusId == 1 ? "bg-info" : item.StatusId == 2 ? "bg-success" : "bg-light text-dark border")">
                                              @(item.StatusId == 1 ? "Pending" : item.StatusId == 2 ? "Approved" : "Draft")
                                          </span>
                                          <div class="small fw-bold mt-1 text-primary">@item.NoOfDays Days</div>
                                     </div>
                                 </div>
                             }
                         </div>
                     }
                     else
                     {
                         <div class="text-center p-4 text-muted">
                             <i class="fas fa-history mb-2 fs-2 opacity-50"></i>
                             <p>No recent leave requests.</p>
                         </div>
                     }
                </div>
            </div>
        }
    </div>
</div>

@code {
    private PropertyChangedEventHandler? _propertyChangedHandler;

    protected override async Task OnInitializedAsync()
    {
        _propertyChangedHandler = (sender, e) => _ = InvokeAsync(StateHasChanged);
        ViewModel.PropertyChanged += _propertyChangedHandler;
        
        await ViewModel.InitializeAsync();
    }
    
    private Task HandleFilesSelected(List<IBrowserFile> files)
    {
        // Store file names for now (actual upload would happen on submit)
        ViewModel.AttachedDocuments = files.Select(f => f.Name).ToList();
        return Task.CompletedTask;
    }
    
    public void Dispose()
    {
        if (_propertyChangedHandler != null && ViewModel != null)
        {
            ViewModel.PropertyChanged -= _propertyChangedHandler;
            _propertyChangedHandler = null;
        }
        
        ViewModel?.Dispose();
    }
}
